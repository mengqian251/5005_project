<!DOCTYPE html>
<meta charset="utf-8">
<style>
    .links line {
        stroke: #999;
        stroke-opacity: 0.6;
    }

    .nodes circle {
        stroke: #fff;
        stroke-width: 1.5px;
    }
</style>
<svg width="960" height="600"></svg>
<script src="https://d3js.org/d3.v4.min.js"></script>
<script>

    var length = [160, 100, 120, 120, 40]; // 1-2, 2-3, 3-4, 3-6, 6-5
    var size = [15, 12, 40, 8, 10, 40]; // employee, handler, middleman....

    var svg = d3.select("svg"),
        width = +svg.attr("width"),
        height = +svg.attr("height");

    var color = d3.scaleOrdinal(d3.schemeCategory20);

    var simulation = d3.forceSimulation()
        .force("link", d3.forceLink().id(function(d) {
            return d.id;
        }))
        .force("charge", d3.forceManyBody())
        .force("center", d3.forceCenter(width / 2, height / 2));
    
    var showLeaf = false;
    var showLeaf1 = false;
    d3.json("links.json", function(error, data) {
        if (error) throw error;
        var graph = {
            nodes: data.nodes
        }
        graph.links = data.links.map(item => {
            return {
                "source": data.nodes[item.source]['id'],
                "target": data.nodes[item.target]['id'],
                "value": item.value
            }
        })
        
        var link = svg.append("g")
            .attr("class", "links")
            .selectAll("line")
            .data(graph.links)
            .enter().append("line");

        var node = svg.append("g")
            .attr("class", "nodes")
            .selectAll("circle")
            .data(graph.nodes)
            .enter().append("circle")
            .call(d3.drag()
                .on("start", dragstarted)
                .on("drag", dragged)
                .on("end", dragended))
            .attr("fill", function(d) {
                return color(d.group);
            })
            .on('click', cn =>  {
                if(cn.id == boss){
            
                   console.log(cn);
                   simulation.stop();
                   showLeaf = true;
                   //update();
                   //simulation.restart();
                }
                if(cn.id == middleman){
            
                   console.log(cn);
                   simulation.stop();
                   showLeaf1 = true;
                   //update();
                   //simulation.restart();
                }
                update();
                simulation.restart();
            });

        node.append("title")
            .text(function(d) {
                return d.id;
            });

        simulation
            .nodes(graph.nodes)
            .on("tick", ticked);

        function ticked() {
            link
                .attr("x1", function(d) {
                    return d.source.x;
                })
                .attr("y1", function(d) {
                    return d.source.y;
                })
                .attr("x2", function(d) {
                    return d.target.x;
                })
                .attr("y2", function(d) {
                    return d.target.y;
                });

            node
                .attr("cx", function(d) {
                    return d.x;
                })
                .attr("cy", function(d) {
                    return d.y;
                });
        }

        // Boss
        let boss = 'szemeredi'; //Why?
        function isBossLeaf(id){
            var isLeaf = graph.links.filter(l =>
                l.source == id
            ).length == 0;
            var onlyConnectToBoss = graph.links.filter(l =>
                l.source != boss && l.target == id
            ).length == 0;
            return isLeaf && onlyConnectToBoss;
        }
        var leafIDs = graph.nodes.filter(n => {
            return isBossLeaf(n.id);
        }).map(n => n.id)
        
        // Middle man
        let middleman = 'good';
        function isMiddlemanLeaf(id){
            var isLeaf = graph.links.filter(l =>
                l.source == id
            ).length == 0;
            var onlyConnectToMiddleman = graph.links.filter(l =>
                l.source != middleman && l.target == id && l.source == 'moilanen'
            ).length == 0;
            return isLeaf && onlyConnectToMiddleman;
        }
        var leafIDs1 = graph.nodes.filter(n => {
            //console.log(leafIDs1);
            return isMiddlemanLeaf(n.id);
        }).map(n => n.id)

        function update(){
            node.attr("r", d => {
                 if (leafIDs.includes(d.id) && !showLeaf) {
                     return 0;  
                 } else if (leafIDs1.includes(d.id) && !showLeaf1) {
                     return 0;
                 } else if (d.group == 1) { // dark blue
                     return size[0];
                 } else if (d.group == 2) { // light blue
                     return size[1];
                 } else if (d.group == 3) { // dark orange
                     return size[2];
                 } else if (d.group == 4) { // light orange -- middle man
                     return size[3];
                 } else if (d.group == 5) { // dark green
                     return size[4];
                 } else { //  light green
                     return size[5];
                 }
                //return  leafIDs.includes(d.id) && !showLeaf? 0 : 7;
            })
            link.attr("stroke-width", function(l) {
                //console.log(showLeaf1);
                 if (leafIDs.includes(l.target) && !showLeaf) {
                    return 0;
                 } else if (leafIDs1.includes(l.target) && !showLeaf1) {
                    return 0;
                 } else {
                    return Math.sqrt(l.value);
                 }
                //return  leafIDs.includes(l.target) && !showLeaf? 0 : Math.sqrt(l.value);
            })
            simulation
                .force("link")
                .links(graph.links)
                .distance(l => {
                    //console.log(showLeaf1);
                    //console.log(showLeaf);
                    if(leafIDs.includes(l.target.id) && !showLeaf) {
                               return 0;
                    } else if (leafIDs1.includes(l.target.id) && !showLeaf1) {
                               return 0;
                    } else if (l.source.group == 1 && l.target.group == 2){
                               return length[0];
                    } else if (l.source.group == 2 && l.target.group == 3){ 
                               return length[1];
                    } else if (l.source.group == 3 && l.target.group == 4){ // !!!! boss-->4
                               return length[2];
                    } else if (l.source.group == 3 && l.target.group == 6){
                               return length[3];
                    } else { // 6 and 5
                               return length[4]; // length insde
                    }
                    //return  leafIDs.includes(l.target.id) && !showLeaf? 0 : 60;
                });
        }
        update();
    });

    function dragstarted(d) {
        if (!d3.event.active) simulation.alphaTarget(0.3).restart();
        d.fx = d.x;
        d.fy = d.y;
    }

    function dragged(d) {
        d.fx = d3.event.x;
        d.fy = d3.event.y;
    }

    function dragended(d) {
        if (!d3.event.active) simulation.alphaTarget(0);
        d.fx = null;
        d.fy = null;
    }
</script>
